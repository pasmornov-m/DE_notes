# SNOWFLAKE

---

## Введение

**Snowflake** — это комплексная облачная платформа данных, предоставляемая по модели «программное обеспечение как услуга» (SaaS), которая в единой среде объединяет функциональность хранилища данных (Data Warehouse), озера данных (Data Lake) и аналитических систем, полностью абстрагируя пользователей от управления базовой инфраструктурой и предоставляя для работы с данными интерфейс на основе стандартного SQL.

Ключевое отличие Snowflake от традиционных хранилищ и конкурентов, таких как Amazon Redshift, Google BigQuery или Microsoft Azure Synapse, заключается в его уникальной многокластерной архитектуре с полным разделением ресурсов хранения (storage) и вычислений (compute). Такая архитектура обеспечивает хорошую масштабируемость и параллельность при обработке запросов.

Snowflake полностью абстрагирует пользователей от сложностей управления инфраструктурой, позволяя сконцентрироваться исключительно на работе с данными. Платформа поддерживает стандартный SQL, что упрощает миграцию для команд, уже имеющих опыт работы с реляционными базами данных.

---

## Архитектура

В основе Snowflake лежит трёхуровневая архитектура.

1. Уровень хранения данных (Database Storage)

Все данные, загруженные в Snowflake, автоматически преобразуются в собственный оптимизированный, сжатый колоночный формат. Этот уровень отвечает за сохранность, отказоустойчивость и управление данными, включая организацию таблиц, шифрование и метаданные. Также, этот уровень полностью отделён от вычислительных ресурсов.

2. Уровень вычислений (Query Pricessing)

Обработка запросов в Snowflake выполняется с помощью "виртуальных хранилищ" (Virtual Warehouses). Virtual Warehouse - это кластер из одного или нескольких вычислительных узлов (nodes), которые запрашивают данные с уровня хранения для выполнения SQL-запросов. Каждое такое хранилище работает независимо, не разделяя ресурсы с другими. Это позволяет разным пользователям работать с одними и теми же данными одновременно, не влияя на производительност друг друга. Хранилища можно масштабировать "на лету" - увеличивать или уменьшать их мощность, а также автоматически приостанавливать при отсутствии нагрузки.

3. Уровень облачных сервисов (Cloud Services)

Это основная часть всей платформы Snowflake. Этот уровень координирует все действия внутри системы. Он отвечает за управление транзакциями, аутентификацию пользователей, управление метаданными, оптимиацию запросов и контроль доступа. Именно этот слой обеспечивает согласованность данных и выполняет всю фоновую работу, обеспечивая простое и надёжное взаимодействие конечного пользователя с платформой.

![Архитектура Snowflake](../png/snowflake_1.png)

*Архитектура Snowflake*

---

## Основные особенности

- Time travel

Эта функция позволяет "откатить" состояние данных на определённый момент в прошлом. Snowflake хранит историю изменений данных в течение настраиваемого периода (до 90 дней). Это обеспечивает возможность анализа исторических данных, а также упрощённый процесс восстановления данных.

- Zero-copy clonning

Snowflake позволяет создавать полные копии баз данных, схем или отдельных таблицпрактически мгновенно и без дублирования физического хранения данных. Клон является "записью по ссылке" на исходные данные. Изменения в клоне записываются как дельта, что делает процесс крайне эффективным для создания отдельеных сред для разработки и тестирования.

- Secure data sharing

Пользователи могут безопасно делиться данными с другими аккаунтами Snowflake без необходимости копировать или перемещать сами данные. Провайдер данных просто предоставляет защищённый доступ к своему хранилищу, а потребитель использует собственные вычислительные ресурсы для их анализа.

- Snowpipe

Сервис для непрерывной и автоматизированной загрузки данных. Snowpipe отслеживает файлы в указанном внешнем хранилище (например S3) и автоматически загружает новые данные в таблицы Snowflake по мере их появления, что идеально подходит для потоковых сценариев.

---

## Примеры реализации

Snowflake использует стандартный ANSI SQL, что делает его интуитивно понятным для большинства аналитиков и инженеров. Рассмотрим базовый сценарий работы.

- Шаг 1: Создание и настройка Virtual Warehouse

Сначала создадим вычислительный кластер. Укажем его размер (X-Small — самый маленький), политику автоматической приостановки через 5 минут бездействия и автоматического возобновления при поступлении запроса.

```sql
-- Создание виртуального склада для аналитических задач
CREATE OR REPLACE WAREHOUSE ANALYTICS_WH
    WAREHOUSE_SIZE = 'XSMALL'
    AUTO_SUSPEND = 300 -- в секундах
    AUTO_RESUME = TRUE
    COMMENT = 'Склад для команды бизнес-аналитики';
```

- Шаг 2: Создание базы данных и таблицы

Теперь создадим окружение для наших данных — базу данных и таблицу для хранения информации о продажах.

```sql
-- Создание базы данных для отдела продаж
CREATE OR REPLACE DATABASE SALES_DB;

-- Переключение на созданную базу данных для дальнейшей работы
USE DATABASE SALES_DB;

-- Создание таблицы для хранения транзакций
CREATE OR REPLACE TABLE TRANSACTIONS (
    transaction_id INT,
    product_name VARCHAR(100),
    sale_amount DECIMAL(10, 2),
    transaction_date TIMESTAMP_NTZ
);
```

- Шаг 3: Вставка данных и выполнение запроса

Загрузим несколько строк в нашу таблицу и выполним простой аналитический запрос для подсчета выручки по продуктам.

```sql
-- Вставка данных о продажах
INSERT INTO TRANSACTIONS (
    transaction_id, 
    product_name, 
    sale_amount, 
    transaction_date) 
VALUES
    (1, 'Laptop', 1200.00, '2025-07-24 10:00:00'),
    (2, 'Mouse', 25.50, '2025-07-24 10:05:00'),
    (3, 'Laptop', 1250.00, '2025-07-24 11:30:00'),
    (4, 'Keyboard', 75.00, '2025-07-24 12:00:00');

-- Активация нашего склада (если он был приостановлен)
USE WAREHOUSE ANALYTICS_WH;

-- Запрос на получение общей выручки по каждому продукту
SELECT
    product_name,
    SUM(sale_amount) as total_revenue
FROM TRANSACTIONS
GROUP BY product_name
ORDER BY total_revenue DESC;
```

На этом примере видно, как в Snowflake разделены задачи управления инфраструктурой (создание хранилища) и работа с данными (SQL-запросы), что является основой его гибкости.

---

### Использованные ресурсы

[Snowflakes](https://bigdataschool.ru/wiki/snowflakes/)